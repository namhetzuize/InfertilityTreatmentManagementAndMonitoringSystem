@page "/MedicalProfileDetails/{customerId:guid}/{doctorId:guid}"
@model InfertilityTreatmentSystem.Pages.MedicalProfileDetailsModel
@using System.Security.Claims

@{
    ViewData["Title"] = "Chi tiết hồ sơ bệnh án";
    var role = User.FindFirstValue(ClaimTypes.Role);
}

<div class="container py-4">
    <h2 class="fw-bold text-primary mb-4">
        🩺 Hồ sơ bệnh nhân: @Model.Customer?.FullName
    </h2>

    @* ───── LỊCH KHÁM ───── *@
    <div class="mb-4">
        <h4 class="text-success">📅 Lịch khám</h4>

        @* Only doctors can create new schedules *@
        @if (role == "Doctor")
        {
            <form method="post" asp-page-handler="CreateSchedule"
                  asp-route-customerId="@Model.Customer.UserId"
                  asp-route-doctorId="@Model.DoctorId"
                  class="row g-2 mb-3">
                <div class="col-md-4">
                    <label class="form-label">Ngày khám:</label>
                    <input asp-for="NewSchedule.ScheduleDate" type="datetime-local" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Dịch vụ:</label>
                    <input asp-for="NewSchedule.SerivceName" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Ghi chú:</label>
                    <input asp-for="NewSchedule.Note" class="form-control" />
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">➕ Tạo lịch khám</button>
                </div>
            </form>
        }

        @* everyone can view schedules *@
        @if (Model.Schedules?.Any() == true)
        {
            <button class="btn btn-outline-primary mb-3" data-bs-toggle="collapse" data-bs-target="#scheduleListCollapse">
                📅 Xem lịch khám
            </button>
            <div class="collapse" id="scheduleListCollapse">
                <ul class="list-group">
                    @foreach (var sch in Model.Schedules.OrderBy(s => s.ScheduleDate))
                    {
                        <li class="list-group-item">
                            @sch.ScheduleDate?.ToString("dd/MM/yyyy HH:mm") – <strong>@sch.SerivceName</strong><br />
                            <small>@sch.Note</small>
                        </li>
                    }
                </ul>
            </div>
        }
        else
        {
            <div class="alert alert-info">Không có lịch khám nào.</div>
        }
    </div>

    @* ───── HỒ SƠ BỆNH ÁN ───── *@
    <div class="mb-4">
        <h4 class="text-danger">📋 Hồ sơ bệnh án</h4>

        @* Only doctors can add new medical records *@
        @if (role == "Doctor")
        {
            <form method="post" asp-page-handler="CreateMedicalRecord"
                  asp-route-customerId="@Model.Customer.UserId"
                  asp-route-doctorId="@Model.DoctorId"
                  class="row g-2 mb-3 bg-light border p-3 rounded">
                <div class="col-md-4">
                    <label class="form-label">Kết quả xét nghiệm:</label>
                    <input asp-for="NewMedicalRecord.TestResults" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Đơn thuốc:</label>
                    <input asp-for="NewMedicalRecord.Prescription" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Ghi chú:</label>
                    <input asp-for="NewMedicalRecord.Note" class="form-control" />
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-danger">➕ Tạo hồ sơ bệnh án</button>
                </div>
            </form>
        }

        @* everyone can view records *@
        @if (Model.MedicalRecords?.Any() == true)
        {
            <button class="btn btn-outline-danger mb-3" data-bs-toggle="collapse" data-bs-target="#recordListCollapse">
                📋 Xem hồ sơ bệnh án
            </button>
            <div class="collapse" id="recordListCollapse">
                <ul class="list-group">
                    @foreach (var mr in Model.MedicalRecords.OrderBy(r => r.CreatedDate))
                    {
                        <li class="list-group-item">
                            <strong>Ngày:</strong> @mr.CreatedDate.ToString("dd/MM/yyyy HH:mm")<br />
                            <strong>Test:</strong> @mr.TestResults<br />
                            <strong>Rx:</strong> @mr.Prescription<br />
                            <em>@mr.Note</em>
                        </li>
                    }
                </ul>
            </div>
        }
        else
        {
            <div class="alert alert-info">Chưa có hồ sơ bệnh án nào.</div>
        }
    </div>

    @* ───── YÊU CẦU TỪ BỆNH NHÂN ───── *@
    <div class="mb-4">
        <h4 class="text-warning">📝 Yêu cầu từ bệnh nhân</h4>

        @if (role == "Customer")
        {
            <form method="post"
                  asp-page-handler="CreatePatientRequest"
                  asp-route-customerId="@Model.CustomerId"
                  asp-route-doctorId="@Model.DoctorId"
                  class="row g-2 mb-3 bg-light border p-3 rounded">

                <div class="col-md-6">
                    <label class="form-label">Dịch vụ yêu cầu:</label>
                    <select asp-for="NewRequest.ServiceId"
                            asp-items="Model.ServiceItems"
                            class="form-select">
                        <option value="">-- Chọn dịch vụ --</option>
                    </select>
                    <span asp-validation-for="NewRequest.ServiceId" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Ghi chú:</label>
                    <input asp-for="NewRequest.Note" class="form-control" />
                    <span asp-validation-for="NewRequest.Note" class="text-danger"></span>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-warning">➕ Tạo yêu cầu</button>
                </div>
            </form>
        }

        @if (Model.PatientRequests?.Any() == true)
        {
            <button class="btn btn-outline-warning mb-2"
                    data-bs-toggle="collapse"
                    data-bs-target="#reqListCollapse">
                📝 Xem yêu cầu
            </button>
            <div class="collapse" id="reqListCollapse">
                <ul class="list-group">
                    @foreach (var pr in Model.PatientRequests)
                    {
                        <li class="list-group-item">
                            <strong>@pr.RequestedDate: </strong>
                            @pr.Service.ServiceName – @pr.Note
                        </li>
                    }
                </ul>
            </div>
        }
        else
        {
            <div class="alert alert-info">Chưa có yêu cầu nào.</div>
        }
    </div>
</div>
